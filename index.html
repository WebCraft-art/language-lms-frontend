<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>AKW Lingua — Offline LMS</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="max-w-4xl mx-auto p-4">
    <!-- HEADER -->
    <header class="flex justify-between items-center border-b pb-4 mb-4">
      <h1 class="text-xl font-bold">AKW Lingua</h1>
      <div id="userControls" class="flex gap-2"></div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="app"></main>
  </div>

  <script>
    // === Data seed ===
    const seedCourses = [
      {
        id: crypto.randomUUID(),
        slug: "angielski-a1",
        language: "en",
        level: "A1",
        price: 199,
        translations: [{ lang: "pl", title: "Angielski A1", description: "Podstawowy kurs języka angielskiego" }],
        modules: [
          {
            id: crypto.randomUUID(),
            title: "Module 1",
            lessons: [
              { id: crypto.randomUUID(), title: "Lesson 1", content: "Wprowadzenie — alfabet" },
              { id: crypto.randomUUID(), title: "Lesson 2", content: "Podstawowe zwroty" }
            ]
          }
        ]
      }
    ];

    // === Init localStorage ===
    function initStorage() {
      if (!localStorage.getItem("courses")) {
        localStorage.setItem("courses", JSON.stringify(seedCourses));
      }
      if (!localStorage.getItem("users")) {
        localStorage.setItem("users", JSON.stringify([]));
      }
    }

    // === Helpers ===
    function getCourses() {
      return JSON.parse(localStorage.getItem("courses") || "[]");
    }
    function getUsers() {
      return JSON.parse(localStorage.getItem("users") || "[]");
    }
    function saveUsers(users) {
      localStorage.setItem("users", JSON.stringify(users));
    }
    function getCurrentUser() {
      const id = localStorage.getItem("currentUserId");
      return getUsers().find(u => u.id === id) || null;
    }
    function setCurrentUser(id) {
      localStorage.setItem("currentUserId", id);
    }
    function logoutUser() {
      localStorage.removeItem("currentUserId");
      render();
    }

    // === Auth logic ===
    function register(name, email, password) {
      const users = getUsers();
      if (users.find(u => u.email === email)) {
        alert("Email już istnieje.");
        return;
      }
      const newUser = { id: crypto.randomUUID(), name, email, password, role: "student", orders: [], progress: {} };
      users.push(newUser);
      saveUsers(users);
      setCurrentUser(newUser.id);
      render();
    }
    function login(email, password) {
      const user = getUsers().find(u => u.email === email && u.password === password);
      if (!user) {
        alert("Błędny email lub hasło.");
        return;
      }
      setCurrentUser(user.id);
      render();
    }

    // === Course logic ===
    function buyCourse(courseId) {
      const user = getCurrentUser();
      if (!user) {
        alert("Musisz się zalogować");
        return;
      }
      if (!user.orders.includes(courseId)) {
        user.orders.push(courseId);
      }
      const users = getUsers().map(u => u.id === user.id ? user : u);
      saveUsers(users);
      render();
    }
    function completeLesson(courseId, lessonId) {
      const user = getCurrentUser();
      if (!user.progress[courseId]) user.progress[courseId] = {};
      user.progress[courseId][lessonId] = true;
      const users = getUsers().map(u => u.id === user.id ? user : u);
      saveUsers(users);
      render();
    }
    function progressPercent(course, user) {
      const total = course.modules.reduce((sum, m) => sum + m.lessons.length, 0);
      const done = Object.keys(user.progress[course.id] || {}).length;
      return total ? Math.round((done / total) * 100) : 0;
    }

    // === UI render ===
    function renderHeader() {
      const userControls = document.getElementById("userControls");
      const user = getCurrentUser();
      if (user) {
        userControls.innerHTML = `
          <span>Witaj, ${user.name}</span>
          <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="logoutUser()">Wyloguj</button>
        `;
      } else {
        userControls.innerHTML = `
          <button class="bg-blue-500 text-white px-3 py-1 rounded" onclick="showLogin()">Zaloguj</button>
          <button class="bg-green-500 text-white px-3 py-1 rounded" onclick="showRegister()">Rejestracja</button>
        `;
      }
    }

    function showCourses() {
      const courses = getCourses();
      const app = document.getElementById("app");
      app.innerHTML = `<h2 class="text-lg font-bold mb-4">Kursy</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${courses.map(c => `
            <div class="border p-4 rounded shadow">
              <h3 class="font-bold">${c.translations[0].title}</h3>
              <p>${c.translations[0].description}</p>
              <div class="flex justify-between items-center mt-2">
                <span>${c.price} PLN</span>
                <button class="bg-blue-500 text-white px-3 py-1 rounded" onclick="showCourse('${c.slug}')">Szczegóły</button>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function showCourse(slug) {
      const course = getCourses().find(c => c.slug === slug);
      const user = getCurrentUser();
      const bought = user && user.orders.includes(course.id);
      const app = document.getElementById("app");
      app.innerHTML = `
        <button class="mb-2 underline" onclick="showCourses()">← Powrót</button>
        <h2 class="text-lg font-bold mb-2">${course.translations[0].title}</h2>
        <p>${course.translations[0].description}</p>
        <div class="my-2">
          ${bought 
            ? `<span class="text-green-600 font-bold">Zakupiono</span>`
            : `<button class="bg-green-500 text-white px-3 py-1 rounded" onclick="buyCourse('${course.id}')">Kup kurs</button>`}
        </div>
        <div>
          ${course.modules.map(m => `
            <h3 class="font-semibold mt-4">${m.title}</h3>
            <ul class="ml-4 list-disc">
              ${m.lessons.map(l => `
                <li>
                  <button class="underline" onclick="showLesson('${course.id}','${l.id}')">${l.title}</button>
                  ${user?.progress?.[course.id]?.[l.id] ? "✅" : ""}
                </li>
              `).join("")}
            </ul>
          `).join("")}
        </div>
      `;
    }

    function showLesson(courseId, lessonId) {
      const course = getCourses().find(c => c.id === courseId);
      const lesson = course.modules.flatMap(m => m.lessons).find(l => l.id === lessonId);
      const user = getCurrentUser();
      const bought = user && user.orders.includes(course.id);
      if (!bought) {
        alert("Kup kurs, aby otworzyć lekcję.");
        return;
      }
      document.getElementById("app").innerHTML = `
        <button class="mb-2 underline" onclick="showCourse('${course.slug}')">← Powrót</button>
        <h2 class="text-lg font-bold mb-2">${lesson.title}</h2>
        <p class="mb-4">${lesson.content}</p>
        <button class="bg-blue-500 text-white px-3 py-1 rounded" onclick="completeLesson('${course.id}','${lesson.id}')">Oznacz jako ukończone</button>
      `;
    }

    function showRegister() {
      document.getElementById("app").innerHTML = `
        <h2 class="text-lg font-bold mb-2">Rejestracja</h2>
        <form class="flex flex-col gap-2" onsubmit="handleRegister(event)">
          <input class="border p-2" name="name" placeholder="Imię" required />
          <input class="border p-2" name="email" type="email" placeholder="Email" required />
          <input class="border p-2" name="password" type="password" placeholder="Hasło" required />
          <button class="bg-green-500 text-white px-3 py-1 rounded">Zarejestruj</button>
        </form>
      `;
    }
    function handleRegister(e) {
      e.preventDefault();
      const form = e.target;
      register(form.name.value, form.email.value, form.password.value);
    }

    function showLogin() {
      document.getElementById("app").innerHTML = `
        <h2 class="text-lg font-bold mb-2">Logowanie</h2>
        <form class="flex flex-col gap-2" onsubmit="handleLogin(event)">
          <input class="border p-2" name="email" type="email" placeholder="Email" required />
          <input class="border p-2" name="password" type="password" placeholder="Hasło" required />
          <button class="bg-blue-500 text-white px-3 py-1 rounded">Zaloguj</button>
        </form>
      `;
    }
    function handleLogin(e) {
      e.preventDefault();
      const form = e.target;
      login(form.email.value, form.password.value);
    }

    function showDashboard() {
      const user = getCurrentUser();
      if (!user) {
        alert("Musisz być zalogowany.");
        return;
      }
      const myCourses = getCourses().filter(c => user.orders.includes(c.id));
      document.getElementById("app").innerHTML = `
        <h2 class="text-lg font-bold mb-4">Twój Dashboard</h2>
        ${myCourses.length === 0 ? "<p>Brak kursów.</p>" : `
          ${myCourses.map(c => `
            <div class="border p-2 mb-2 rounded">
              <div class="font-bold">${c.translations[0].title}</div>
              <div>Postęp: ${progressPercent(c, user)}%</div>
              <button class="underline" onclick="showCourse('${c.slug}')">Otwórz kurs</button>
            </div>
          `).join("")}
        `}
      `;
    }

    function render() {
      renderHeader();
      showCourses();
    }

    // Init
    initStorage();
    render();
  </script>
</body>
</html>
